package lsieun;import lsieun.utils.FileUtils;import org.objectweb.asm.*;/***  生成*** */public class ClassFileGenerator {    public static void main(String[] args) {        String relativePath = "sample/HelloWorld.class";        String filePath = FileUtils.getFilePath(relativePath);        //byte[] bytes = dump();        byte[] bytes = dum12();        FileUtils.writeBytes(filePath, bytes);    }    /**     * 生成接口     *  public interface HelloWorld {}     * @return     */    public static byte[] dump() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_ABSTRACT | Opcodes.ACC_INTERFACE,                "sample/HelloWorld",                null,                "java/lang/Object",                null);        cw.visitEnd();        return cw.toByteArray();    }    /**     * 生成接口 + 字段 + 方法     * public interface HelloWorld extends Cloneable {     *     int LESS = 0;     *     int compareTo(Object o);     * }     */    public static byte[] dump2() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_ABSTRACT | Opcodes.ACC_INTERFACE,                "sample/HelloWorld",                null,                "java/lang/Object",                new String[] {"java/lang/Cloneable"});        FieldVisitor fv = cw.visitField(Opcodes.ACC_PUBLIC | Opcodes.ACC_FINAL | Opcodes.ACC_STATIC,                "LESS",                "I",                null,                -1);        fv.visitEnd();        MethodVisitor mv = cw.visitMethod(Opcodes.ACC_PUBLIC | Opcodes.ACC_ABSTRACT,                "compareTo",                "(Ljava/lang/Object;)I",                null,                null);        mv.visitEnd();        cw.visitEnd();        return cw.toByteArray();    }    /**     * 生成类     * public class HelloWorld {     *  static {     *      System.out.printf("static code block")     *  }     * }     */    public static byte[] dump3() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_SUPER,                "sample/HelloWorld",                null,                "java/lang/Object",                null);        MethodVisitor mv = cw.visitMethod(Opcodes.ACC_PUBLIC,                "<init>",                "()V",                null,                null);        mv.visitCode();        mv.visitEnd();        MethodVisitor mv2 = cw.visitMethod(Opcodes.ACC_STATIC,                "<cinit>",                "()V",                null,                null);        mv2.visitCode();        mv2.visitEnd();        cw.visitEnd();        return cw.toByteArray();    }    /**     * public interface HelloWorld {     *   @MyTag(name="tomcat", age = 10)     *   int intValue = 10;     *     * }     *     * public @interface MyTag {     *     String name();     *     int age();     * }     *     *     * @return     */    public static byte[] dump4() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_ABSTRACT | Opcodes.ACC_INTERFACE,                "sample/HelloWorld",                null,                "java/lang/Object",                null);        FieldVisitor fv = cw.visitField(Opcodes.ACC_PRIVATE ,                "LESS",                "I",                null,                -1);        fv.visitEnd();        cw.visitEnd();        return cw.toByteArray();    }    /**     * methodVisitor 示例， 构造方法     */    public static byte[] dump5() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_SUPER,                "sample/HelloWorld",                null,                "java/lang/Object",                null);        MethodVisitor mv = cw.visitMethod(Opcodes.ACC_PUBLIC,                "<init>",                "()V",                null,                null);        mv.visitCode();        mv.visitVarInsn(Opcodes.ALOAD, 0);        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, "java/lang/Object","<init>", "()V", false);        mv.visitInsn(Opcodes.RETURN);        mv.visitMaxs(1, 1);        mv.visitEnd();        cw.visitEnd();        return cw.toByteArray();    }    /**     * 静态代码块生成     *     */    public static byte[] dump6() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_SUPER,                "sample/HelloWorld",                null,                "java/lang/Object",                null);        MethodVisitor mv = cw.visitMethod(Opcodes.ACC_PUBLIC,                "<init>",                "()V",                null,                null);        mv.visitCode();        mv.visitVarInsn(Opcodes.ALOAD, 0);        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, "java/lang/Object","<init>", "()V", false);        mv.visitInsn(Opcodes.RETURN);        mv.visitMaxs(1, 1);        mv.visitEnd();        mv = cw.visitMethod(Opcodes.ACC_STATIC, "<clinit>", "()V", null, null);        mv.visitCode();        mv.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");        mv.visitLdcInsn("class initialization");        mv.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);        mv.visitInsn(Opcodes.RETURN);        mv.visitMaxs(2, 0);        mv.visitEnd();        cw.visitEnd();        return cw.toByteArray();    }    /**     * 创建对象     */    public static byte[] dump7() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_SUPER,                "sample/HelloWorld",                null,                "java/lang/Object",                null);        MethodVisitor mv = cw.visitMethod(Opcodes.ACC_PUBLIC,                "<init>",                "()V",                null,                null);        mv.visitCode();        mv.visitVarInsn(Opcodes.ALOAD, 0);        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, "java/lang/Object","<init>", "()V", false);        mv.visitInsn(Opcodes.RETURN);        mv.visitMaxs(1, 1);        mv.visitEnd();        mv = cw.visitMethod(Opcodes.ACC_PUBLIC, "test", "()V", null, null);        mv.visitCode();        mv.visitTypeInsn(Opcodes.NEW, "sample/GoodChild");        mv.visitInsn(Opcodes.DUP);        mv.visitLdcInsn("lucy");        mv.visitIntInsn(Opcodes.BIPUSH, 8);        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, "sample/GoodChild", "<init>", "(Ljava/lang/String;I)V", false);        mv.visitVarInsn(Opcodes.ASTORE, 1);        mv.visitInsn(Opcodes.RETURN);        mv.visitMaxs(4, 2);        mv.visitEnd();        cw.visitEnd();        return cw.toByteArray();    }    /**     * 调用方法     *     */    public static byte[] dum8() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_SUPER,                "sample/HelloWorld",                null,                "java/lang/Object",                null);        MethodVisitor mv = cw.visitMethod(Opcodes.ACC_PUBLIC,                "<init>",                "()V",                null,                null);        mv.visitCode();        mv.visitVarInsn(Opcodes.ALOAD, 0);        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, "java/lang/Object","<init>", "()V", false);        mv.visitInsn(Opcodes.RETURN);        mv.visitMaxs(1, 1);        mv.visitEnd();        mv = cw.visitMethod(Opcodes.ACC_PUBLIC, "test", "(II)V", null, null);        mv.visitCode();        mv.visitVarInsn(Opcodes.ILOAD, 1);        mv.visitVarInsn(Opcodes.ILOAD, 2);        mv.visitMethodInsn(Opcodes.INVOKESTATIC, "java/lang/Math", "max", "(II)I", false);        mv.visitVarInsn(Opcodes.ISTORE, 3);        mv.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");        mv.visitVarInsn(Opcodes.ILOAD, 3);        mv.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(I)V", false);        mv.visitInsn(Opcodes.RETURN);        mv.visitMaxs(2, 4);        mv.visitEnd();        cw.visitEnd();        return cw.toByteArray();    }    /**     * 交叉使用 MethodVisitor 生成类     *     * */    public static byte[] dum9() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_SUPER,                "sample/HelloWorld",                null,                "java/lang/Object",                null);        MethodVisitor mv = cw.visitMethod(Opcodes.ACC_PUBLIC,                "<init>",                "()V",                null,                null);        mv.visitCode();        mv.visitVarInsn(Opcodes.ALOAD, 0);        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, "java/lang/Object","<init>", "()V", false);        mv.visitInsn(Opcodes.RETURN);        mv.visitMaxs(1, 1);        mv.visitEnd();        {            MethodVisitor mv2 = cw.visitMethod(Opcodes.ACC_PUBLIC, "test", "()V", null, null);            MethodVisitor mv3 = cw.visitMethod(Opcodes.ACC_PUBLIC, "printDate", "()V", null, null);            mv3.visitCode();            mv3.visitTypeInsn(Opcodes.NEW, "java/util/Date");            mv3.visitInsn(Opcodes.DUP);            mv3.visitMethodInsn(Opcodes.INVOKESPECIAL, "java/util/Date", "<init>", null, false);            mv2.visitCode();            mv2.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");            mv2.visitLdcInsn("test method");            mv2.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);            mv3.visitVarInsn(Opcodes.ASTORE, 1);            mv3.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");            mv3.visitVarInsn(Opcodes.ALOAD, 1);            mv3.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/Object;)V", false);            mv2.visitInsn(Opcodes.RETURN);            mv2.visitMaxs(2, 1);            mv2.visitEnd();            mv3.visitInsn(Opcodes.RETURN);            mv3.visitMaxs(2, 2);            mv3.visitEnd();        }        cw.visitEnd();        return cw.toByteArray();    }    /**     * 程序跳转逻辑 if Label     */    public static byte[] dum10() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_SUPER,                "sample/HelloWorld",                null,                "java/lang/Object",                null);        MethodVisitor mv = cw.visitMethod(Opcodes.ACC_PUBLIC,                "<init>",                "()V",                null,                null);        mv.visitCode();        mv.visitVarInsn(Opcodes.ALOAD, 0);        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, "java/lang/Object","<init>", "()V", false);        mv.visitInsn(Opcodes.RETURN);        mv.visitMaxs(1, 1);        mv.visitEnd();        {            MethodVisitor mv2 = cw.visitMethod(Opcodes.ACC_PUBLIC, "test", "(I)V", null, null);            Label elseLabel = new Label();            Label returnLabel = new Label();            mv2.visitCode();            mv2.visitVarInsn(Opcodes.ILOAD, 1);            mv2.visitJumpInsn(Opcodes.IFEQ, elseLabel);            mv2.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");            mv2.visitLdcInsn("value is true");            mv2.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);            mv2.visitJumpInsn(Opcodes.GOTO, returnLabel);            mv2.visitLabel(elseLabel);            mv2.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");            mv2.visitLdcInsn("value is false");            mv2.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);            mv2.visitLabel(returnLabel);            mv2.visitInsn(Opcodes.RETURN);            mv2.visitMaxs(2, 2);            mv2.visitEnd();        }        cw.visitEnd();        return cw.toByteArray();    }    /**     * switch 语句生成     *     * */    public static byte[] dum11() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_SUPER,                "sample/HelloWorld",                null,                "java/lang/Object",                null);        MethodVisitor mv = cw.visitMethod(Opcodes.ACC_PUBLIC,                "<init>",                "()V",                null,                null);        mv.visitCode();        mv.visitVarInsn(Opcodes.ALOAD, 0);        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, "java/lang/Object","<init>", "()V", false);        mv.visitInsn(Opcodes.RETURN);        mv.visitMaxs(1, 1);        mv.visitEnd();        {            Label caseLabel1 = new Label();            Label caseLabel2 = new Label();            Label caseLabel3 = new Label();            Label defaultLabel = new Label();            Label returnLabel = new Label();            MethodVisitor mv2 = cw.visitMethod(Opcodes.ACC_PUBLIC, "test", "(I)V", null, null);            mv2.visitCode();            mv2.visitVarInsn(Opcodes.ILOAD, 1);            mv2.visitTableSwitchInsn(1, 3, defaultLabel, caseLabel1, caseLabel2, caseLabel3);            mv2.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");            mv2.visitLdcInsn("value is unknown");            mv2.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);            mv2.visitLabel(caseLabel1);            mv2.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");            mv2.visitLdcInsn("value is 1");            mv2.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);            mv2.visitJumpInsn(Opcodes.GOTO, returnLabel);            mv2.visitLabel(caseLabel2);            mv2.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");            mv2.visitLdcInsn("value is 2");            mv2.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);            mv2.visitJumpInsn(Opcodes.GOTO, returnLabel);            mv2.visitLabel(caseLabel3);            mv2.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");            mv2.visitLdcInsn("value is 3");            mv2.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);            mv2.visitJumpInsn(Opcodes.GOTO, returnLabel);            mv2.visitLabel(returnLabel);            mv2.visitInsn(Opcodes.RETURN);            mv2.visitMaxs(2, 2);            mv2.visitEnd();        }        cw.visitEnd();        return cw.toByteArray();    }    /**     * for 语句生成     *     */    public static byte[] dum12() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_SUPER,                "sample/HelloWorld",                null,                "java/lang/Object",                null);        MethodVisitor mv = cw.visitMethod(Opcodes.ACC_PUBLIC,                "<init>",                "()V",                null,                null);        mv.visitCode();        mv.visitVarInsn(Opcodes.ALOAD, 0);        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, "java/lang/Object","<init>", "()V", false);        mv.visitInsn(Opcodes.RETURN);        mv.visitMaxs(1, 1);        mv.visitEnd();        {            Label conditionLabel = new Label();            Label returnLabel = new Label();            MethodVisitor mv2 = cw.visitMethod(Opcodes.ACC_PUBLIC, "test2", "(I)V", null, null);            mv2.visitCode();            mv2.visitInsn(Opcodes.ICONST_0);            mv2.visitVarInsn(Opcodes.ISTORE, 2);            mv2.visitLabel(conditionLabel);            mv2.visitVarInsn(Opcodes.ILOAD, 2);            mv2.visitVarInsn(Opcodes.ILOAD, 1);            mv2.visitJumpInsn(Opcodes.IF_ICMPGE, returnLabel);            mv2.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");            mv2.visitVarInsn(Opcodes.ILOAD, 2);            mv2.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);            mv2.visitJumpInsn(Opcodes.GOTO, conditionLabel);            mv2.visitIincInsn(2, 1);            mv2.visitLabel(returnLabel);            mv2.visitInsn(Opcodes.RETURN);            mv2.visitMaxs(2, 2);            mv2.visitEnd();        }        cw.visitEnd();        return cw.toByteArray();    }    /**     * try-catch 语句     * */    public static byte[] dum13() {        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);        cw.visit(Opcodes.V1_8,                Opcodes.ACC_PUBLIC | Opcodes.ACC_SUPER,                "sample/HelloWorld",                null,                "java/lang/Object",                null);        MethodVisitor mv = cw.visitMethod(Opcodes.ACC_PUBLIC,                "<init>",                "()V",                null,                null);        mv.visitCode();        mv.visitVarInsn(Opcodes.ALOAD, 0);        mv.visitMethodInsn(Opcodes.INVOKESPECIAL, "java/lang/Object","<init>", "()V", false);        mv.visitInsn(Opcodes.RETURN);        mv.visitMaxs(1, 1);        mv.visitEnd();        {            Label startLabel = new Label();            Label endLabel = new Label();            Label handlerLabel = new Label();            Label returnLabel = new Label();            MethodVisitor mv2 = cw.visitMethod(Opcodes.ACC_PUBLIC, "test3", "()V", null, null);            mv2.visitCode();            mv2.visitTryCatchBlock(startLabel, endLabel, handlerLabel,"java/lang/InterruptedException");            mv2.visitLabel(startLabel);            mv2.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");            mv2.visitLdcInsn("before sleep");            mv2.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);            mv2.visitLdcInsn(1000L);            mv2.visitMethodInsn(Opcodes.INVOKESTATIC, "java/io/Thread", "sleep", "(J)V", false);            mv2.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");            mv2.visitLdcInsn("after sleep");            mv2.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);            mv2.visitLabel(endLabel);            mv2.visitJumpInsn(Opcodes.GOTO, returnLabel);            mv2.visitLabel(handlerLabel);            mv2.visitVarInsn(Opcodes.ASTORE, 1);            mv2.visitVarInsn(Opcodes.ALOAD, 1);            mv2.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/InterruptedException", "printStackTrace", "()V", false);            mv2.visitLabel(returnLabel);            mv2.visitInsn(Opcodes.RETURN);            mv2.visitMaxs(2, 2);            mv2.visitEnd();        }        cw.visitEnd();        return cw.toByteArray();    }}